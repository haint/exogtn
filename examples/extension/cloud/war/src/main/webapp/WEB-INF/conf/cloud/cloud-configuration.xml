<?xml version="1.0" encoding="ISO-8859-1"?>
<!--

    Copyright (C) 2010 eXo Platform SAS.

    This is free software; you can redistribute it and/or modify it
    under the terms of the GNU Lesser General Public License as
    published by the Free Software Foundation; either version 2.1 of
    the License, or (at your option) any later version.

    This software is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
    Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public
    License along with this software; if not, write to the Free
    Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
    02110-1301 USA, or see the FSF site: http://www.fsf.org.

-->
<configuration
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd http://www.exoplatform.org/xml/ns/kernel_1_2.xsd"
   xmlns="http://www.exoplatform.org/xml/ns/kernel_1_2.xsd">

  <component>
    <key>CloudPropertyManagerConfigurator</key>
    <type>org.exoplatform.container.PropertyConfigurator</type>
    <init-params>
      <value-param>
        <name>properties.url</name>
        <value>file:${gatein.conf.dir}/cloud.properties</value>
      </value-param>
    </init-params>
  </component>

  <component>
    <type>org.exoplatform.services.security.IdentityRegistry </type>
  </component>

  <component>
    <type>org.exoplatform.services.security.ConversationRegistry</type>
  </component>

  <!--cloud-agent -->
  <component>
    <key>com.exoplatform.cloud.CloudAgentApplication</key>
    <type>com.exoplatform.cloud.CloudAgentApplication</type>
  </component>

  <component>
    <key>com.exoplatform.cloud.multitenancy.TenantCommandInvoker</key>
    <type>com.exoplatform.cloud.multitenancy.ExoContainerTenantCommandInvoker</type>
  </component>
 
  <component>
    <type>com.exoplatform.cloud.multitenancy.TemporaryTenantStateHolder</type>
  </component>
  
  <!-- RestRepositoryService -->
  <component>
    <key>org.exoplatform.services.jcr.ext.repository.RestRepositoryService</key>
    <type>org.exoplatform.services.jcr.ext.repository.RestRepositoryService</type>
  </component>

  <!-- RestRegistryService -->
  <!-- component>
    <type>com.exoplatform.cloud.rest.TenancyRESTRegistryService</type>
  </component -->

  <component>
    <type>org.exoplatform.services.jcr.ext.registry.RegistryService</type>
    <init-params>
      <properties-param>
        <name>locations</name>
      </properties-param>
    </init-params>
  </component>

  <!-- Plugins for TenantCreationService START -->
  <component>
    <key>com.exoplatform.cloud.multitenancy.CreateNewRepositoryPlugin</key>
    <!-- type>com.exoplatform.cloud.multitenancy.CreateNewRepositoryPlugin</type -->
    <!-- impl with support of JCR Value storages -->
    <type>org.exoplatform.platform.cloud.services.multitenancy.CreateNewRepositoryPlugin</type>
    <description>Create database</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>10</value>
      </value-param>
      <!-- Removed in CM-1.1 M6 -->
      <!-- value-param>
        <name>configuration-path</name>
        <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/platform-tenant-configuration-template.xml</value>
      </value-param-->
    </init-params>
  </component>

  <component>
    <key>com.exoplatform.cloud.multitenancy.TenantCreationPlugin</key>
    <type>org.exoplatform.platform.cloud.services.multitenancy.InitTenantCreationPlugin</type>
    <description>Creation time update</description>
    <init-params>
      <value-param>
        <name>priority</name>
        <value>10</value>
      </value-param>
    </init-params>
  </component>

  <!-- Tenant local resources -->
  
     <component>
       <key>com.exoplatform.cloud.multitenancy.RepositoryEntryGenerator</key>
       <type>com.exoplatform.cloud.multitenancy.RepositoryEntryGenerator</type>
       <init-params>
       <value-param>
         <name>configuration-path</name>
         <value>file:///${catalina.home}/${exo.conf.dir.name}/cloud/platform-tenant-configuration-template.xml</value>
        </value-param>
       </init-params>
     </component>

     <component>
     <key>com.exoplatform.cloud.multitenancy.TenantLocalResourcesManager</key>
     <type>com.exoplatform.cloud.multitenancy.ExoContainerTenantLocalResourcesManager</type>
     <init-params>
        <value-param>
         <name>configuration-path</name>
         <value>${tenant.template.name}</value>
        </value-param>
     </init-params>
     </component>

     <component>
       <type>com.exoplatform.cloud.multitenancy.resource.TenantLocalLogResources</type>
     </component>

     <component>
       <type>com.exoplatform.cloud.multitenancy.resource.TenantLocalJcrResources</type>
     </component>

    <component>
     <type>com.exoplatform.cloud.multitenancy.resource.TenantDataSources</type>
    </component>
    
    <component>
      <key>org.exoplatform.services.jcr.impl.RepositoryCreationSynchronizer</key>
      <type>org.exoplatform.services.jcr.impl.RepositoryCreationSynchronizer</type>
      <init-params>
        <value-param>
           <name>disabled</name>
           <value>false</value>
        </value-param>
      </init-params>
     </component>

 <!-- Tenant local resources END -->
  
  <component>
  <key>org.exoplatform.services.jcr.RepositoryService</key>
  <type>org.exoplatform.platform.cloud.services.multitenancy.TenantRepositoryService</type>
  <component-plugins>
    <component-plugin>
     <name>add.namespaces</name>
     <set-method>addPlugin</set-method>
     <type>org.exoplatform.services.jcr.impl.AddNamespacesPlugin</type>
     <init-params>
       <properties-param>
         <name>namespaces</name>
         <property name="dc" value="http://purl.org/dc/elements/1.1/" />
         <property name="jos" value="http://www.exoplatform.com/jcr-services/organization-service/1.0/" />
         <property name="exoide" value="http://exoplatform.org/ide/1.1.x/" />
      </properties-param>
     </init-params>
    </component-plugin>
    <component-plugin>
     <name>add.nodeType</name>
     <set-method>addPlugin</set-method>
     <type>org.exoplatform.services.jcr.impl.AddNodeTypePlugin</type>
     <init-params>
       <values-param>
        <name>autoCreatedInNewRepository</name>
        <description>Node types configuration file</description>
        <value>jar:/conf/organization-nodetypes.xml</value>
       </values-param>
     </init-params>
   </component-plugin>
  </component-plugins>
 </component>
  
  <!-- Backup service -->
  <component>
    <key>org.exoplatform.services.jcr.ext.backup.BackupManager</key>
    <type>org.exoplatform.services.jcr.ext.backup.impl.BackupManagerImpl
      </type>
    <init-params>
      <value-param>
        <name>force-xml-configuration</name>
        <value>${exo.backup.force-xml-configuration:false}</value>
      </value-param>
      <properties-param>
        <name>backup-properties</name>
        <property name="default-incremental-job-period" value="${exo.backup.default-incremental-job-period:3600}" />
        <property name="full-backup-type" value="${exo.backup.full-backup-type:org.exoplatform.services.jcr.ext.backup.impl.rdbms.FullBackupJob}" />
        <property name="incremental-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.IncrementalBackupJob" />
        <property name="backup-dir" value="${exo.backup.dir}/backup${container.name.suffix}" />
      </properties-param>
    </init-params>
  </component>

  <!-- REST service for BackupManager -->
  <component>
    <type>org.exoplatform.services.jcr.ext.backup.server.HTTPBackupAgent</type>
  </component>

  <!-- JCR Organiation service -->
  <component>
    <key>org.exoplatform.services.organization.OrganizationService</key>
    <type>org.exoplatform.services.jcr.ext.organization.JCROrganizationServiceImpl</type>
    <init-params>
      <value-param>
        <name>storage-workspace</name>
        <description>Workspace in default repository where organization storage will be created</description>
        <value>portal-system</value>
      </value-param>
    </init-params>
  </component>

  <!-- TenantRegistryPlugin support -->
  <component>
    <type>org.exoplatform.services.jcr.ext.repository.RestRepositoryService</type>
	</component>

  <!-- REST stuff START -->
  <component>
    <key>org.everrest.exoplatform.EverrestInitializer</key>
    <type>org.everrest.exoplatform.EverrestInitializer</type>
  </component>
  <component>
    <type>org.everrest.exoplatform.StartableApplication</type>
  </component>
  <component>
    <type>org.everrest.exoplatform.ExoDependencySupplier</type>
  </component>
  
  <component>
    <key>org.exoplatform.services.rest.impl.RequestHandlerImpl</key>
    <type>org.exoplatform.services.rest.impl.RequestHandlerImpl</type>
  </component>

  <component>
    <key>org.exoplatform.services.rest.impl.RequestDispatcher</key>
    <type>org.exoplatform.services.rest.impl.RequestDispatcher</type>
  </component>

  <component>
    <type>org.exoplatform.services.rest.impl.StartableApplication</type>
  </component>

  <component>
    <type>org.exoplatform.services.rest.impl.ProvidersRegistry</type>
  </component>

  <component>
    <type>org.exoplatform.services.rest.impl.ApplicationRegistry</type>
  </component>

  <component>
    <key>org.exoplatform.services.rest.impl.ResourceBinder</key>
    <type>org.exoplatform.services.rest.impl.ResourceBinder</type>
  </component>

  <component>
    <type>org.exoplatform.services.rest.impl.provider.JAXBContextResolver</type>
  </component>

  <component>
    <key>org.exoplatform.services.jcr.ext.repository.creation.RepositoryCreationService</key>
    <type>org.exoplatform.services.jcr.ext.repository.creation.RepositoryCreationServiceImpl</type>
  </component>
  
  <component>
    <key>org.everrest.core.RequestHandler</key>
    <type>org.everrest.exoplatform.ExoRequestHandler</type>
    <init-params>
         <value-param>
         <name>org.everrest.http.method.override</name>
         <value>true</value>
      </value-param>
    </init-params>
   </component>
   
    <component>
      <type>org.everrest.exoplatform.ExoRequestDispatcher</type>
    </component>
    <component>
      <key>org.everrest.core.ResourceBinder</key>
      <type>org.everrest.core.impl.ResourceBinderImpl</type>
   </component>
   
   <component>
     <type>org.everrest.exoplatform.ProvidersRegistry</type>
  </component>
  
   <component>
     <type>org.everrest.exoplatform.ExoDependencySupplier</type>
  </component>

  <!-- JCR Dependencies END -->

  <component>
    <key>org.exoplatform.services.naming.InitialContextInitializer</key>
    <type>org.exoplatform.services.naming.InitialContextInitializer</type>
    <init-params>
      <value-param>
        <name>bindings-store-path</name>
        <value>${tenant.data.dir}/bind-references.xml</value>
      </value-param>
      <value-param>
        <name>overload-context-factory</name>
        <value>true</value>
      </value-param>
    </init-params>
  </component>

  <!-- Override from platform-extension.war, remove IDE code assist  
  <component>
    <type>org.exoplatform.ide.groovy.GroovyScriptServiceApplication</type>
  </component>
  -->
  
  <!-- empty stub for IDE's code assistant REST service   
  <component>
    <type>org.exoplatform.platform.ide.groovy.codeassistant.EmptyCodeAssistant</type>
  </component>
  -->

  <external-component-plugins>
    <!-- The full qualified name of the ExtensibleFilter -->
    <target-component>org.exoplatform.web.filter.ExtensibleFilter</target-component>
    <component-plugin>
      <!-- The name of the plugin -->
      <name>Sample Filter Definition Plugin</name>
      <!-- The name of the method to call on the ExtensibleFilter in order to register the FilterDefinitions -->
      <set-method>addFilterDefinitions</set-method>
      <!-- The full qualified name of the FilterDefinitionPlugin -->
      <type>org.exoplatform.web.filter.FilterDefinitionPlugin</type>
      <init-params>
        <object-param>
          <name>Sample Filter Definition</name>
          <object type="org.exoplatform.web.filter.FilterDefinition">
            <!-- The filter instance -->
            <field name="filter"><object type="org.exoplatform.platform.cloud.services.filter.SetTenantRepositoryFilter"/></field>
            <!-- The mapping to use -->
            <!-- WARNING: the mapping is expressed with regular expressions -->
            <field name="patterns">
              <collection type="java.util.ArrayList" item-type="java.lang.String">
                <value>
                  <string>/.*</string>
                </value>
              </collection>
            </field>
          </object>
        </object-param>
      </init-params>
    </component-plugin>
    <component-plugin>
      <!-- The name of the plugin -->
      <name>Sample Filter Definition Plugin</name>
      <!-- The name of the method to call on the ExtensibleFilter in order to register the FilterDefinitions -->
      <set-method>addFilterDefinitions</set-method>
      <!-- The full qualified name of the FilterDefinitionPlugin -->
      <type>org.exoplatform.web.filter.FilterDefinitionPlugin</type>
      <init-params>
        <object-param>
          <name>Sample Filter Definition</name>
          <object type="org.exoplatform.web.filter.FilterDefinition">
            <!-- The filter instance -->
            <field name="filter"><object type="org.exoplatform.platform.cloud.services.filter.LogbackLoggingFilter"/></field>
            <!-- The mapping to use -->
            <!-- WARNING: the mapping is expressed with regular expressions -->
            <field name="patterns">
              <collection type="java.util.ArrayList" item-type="java.lang.String">
                <value>
                  <string>/.*</string>
                </value>
              </collection>
            </field>
          </object>
        </object-param>
      </init-params>
    </component-plugin>
  </external-component-plugins>

</configuration>
